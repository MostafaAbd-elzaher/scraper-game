# maingame.py
import os
from turtle import up
import pygame
from player import Player
from maze_generator import generate_maze
from enemy import Enemy
import random
from pathlib import Path
import math # ุชุญุชุงุฌ ููุฐุง ุฅุฐุง ูุงู ููุงุณ Coin ูู ูุฐุง ุงูููู


class Coin(pygame.sprite.Sprite):
    def __init__(self, x, y, size, image_path):
        super().__init__()
        original_coin_img = pygame.image.load("coin_gold.png").convert_alpha()
        self.image = pygame.transform.scale(original_coin_img, (size, size))
        self.rect = self.image.get_rect()
        self.rect.topleft = (x, y)
    pass


def display_score(screen, score, win_score):
    global score_font, WIDTH, GREEN, BLACK
    score_text = f"Score: {score} / {win_score}"
    text_surface = score_font.render(score_text, True, GREEN, WHITE) # (ุงููุต, ุณูุงุณุฉ ุงูุญูุงู, ููู ุงููุต, ููู ุงูุฎูููุฉ)
    text_rect = text_surface.get_rect()
    padding = 10
    text_rect.topright = (WIDTH - padding, padding)
    screen.blit(text_surface, text_rect)


pygame.init()

CELL_SIZE = 25
MAZE_COLS = 68
MAZE_ROWS = 31


maze =[[1]*64,
     [1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,1,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,0,0,1,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,1,2,1,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1],
     [1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
     [1]*64
]

# ุฃููุงู
GREEN = (0, 255, 0)
WHITE = (255, 255, 255)
BLACK = (0, 0, 0)
YELLOW = (255, 255, 0)
BLUE = (0, 0, 255)

score_font = pygame.font.SysFont('Arial', 30, bold=True)
# ุญุณุงุจ ุงูุฃุจุนุงุฏ ุงููููุฉ ููุดุจูุฉ (ุงููุณุงุฑุงุช ูุงูุฌุฏุฑุงู)
ROWS = len(maze)      # 31
COLS = len(maze[0])   # 68
# ุญุฌู ุงููุงูุฐุฉ ูุชู ุชุญุฏูุฏู ุงูุขู ุจูุงุกู ุนูู ุงููุชุงูุฉ
WIDTH = COLS * CELL_SIZE # 68 * 30 = 2040
HEIGHT = ROWS * CELL_SIZE # 31 * 30 = 930


COIN_IMAGE_NAME = 'coin_gold.png' # โฌ๏ธ ูู ุจุชุบููุฑู ุฅูู ุงุณู ููู ุงูุนููุฉ ุงูุฎุงุต ุจู
NUM_COINS = 25 # ุนุฏุฏ ุงูุนููุงุช ุงูุนุดูุงุฆู
WINNING_SCORE = 20

screen = pygame.display.set_mode((WIDTH, HEIGHT), pygame.RESIZABLE)
pygame.display.set_caption("Random Maze Game")

try:
    original_bg = pygame.image.load("background_image.png").convert()
    background = pygame.transform.scale(original_bg, (WIDTH, HEIGHT))

except Exception as e:
    print(f"โ ุฎุทุฃ ุชุญููู ุงูุฎูููุฉ: ูุดู ุงูุนุซูุฑ ุนูู ุงูููู ูู ุงููุณุงุฑ: background_image.png. ุงูุฑุฌุงุก ุงูุชุฃูุฏ ูู ูุฌูุฏู. ุฎุทุฃ ุงููุธุงู: {e}")
    # ุฅุฐุง ูุดู ุงูุชุญูููุ ูุณุชุฎุฏู ุณุทุญ ูุงุฑุบ (Fallback)
    background = pygame.Surface((WIDTH, HEIGHT))
    background.fill(WHITE)

coin_group = pygame.sprite.Group()


START_ROW, START_COL = 1, 1
# ุชุนููู ุงูุจุฏุงูุฉ (3)
maze[START_ROW][START_COL] = 3

for i in range(NUM_COINS):
    while True:
        # ูุจุญุซ ุนู ุฎููุฉ ูุณุงุฑ 0 (Path) ุบูุฑ ูุญุฌูุฒุฉ
        r = random.randint(1, ROWS - 2)
        c = random.randint(1, COLS - 2)
        # ูุถูู ุฃู ุชููู ุงูุนููุฉ ูู ูุณุงุฑ ูุงุฑุบ ูููุณุช ุนูู ููุทุฉ ุงูุจุฏุงูุฉ
        if maze[r][c] == 0 and (r, c) != (START_ROW, START_COL):
            # ูุถุน ูููุฉ ูุคูุชุฉ (ูุซูุงู 4) ูุชุฌูุจ ูุถุน ุนููุชูู ูู ููุณ ุงูุฎููุฉ
            maze[r][c] = 4
            break

    coin = Coin(c * CELL_SIZE, r * CELL_SIZE, CELL_SIZE, COIN_IMAGE_NAME)
    coin_group.add(coin)



#maze = generate_maze(MAZE_COLS, MAZE_ROWS)
enemies_group = pygame.sprite.Group()


ENEMY_POSITIONS = [
    (15, 1), # ุนูุฏ ุงูุตู 15ุ ุงูุนููุฏ 1 (ูู ููุชุตู ุงููุชุงูุฉ ุชูุฑูุจุงู)
    (1, 45), # ุนูุฏ ุงูุตู 1ุ ุงูุนููุฏ 45
    (29, 29)# ูุฑูุจ ูู ุงูููุงูุฉ
]
# ุนุฏุฏ ุงูุฃุนุฏุงุก
NUM_ENEMIES = 10
enemy_list = []

for i in range(NUM_ENEMIES):
    # ุงุณุชุฎุฏุงู ุงูููุงูุน ุงููุญุฏุฏุฉ ุฃู ููุงูุน ุนุดูุงุฆูุฉ ุจุนูุฏุฉ ุนู (1, 1)
    # ููุง ูุณุชุฎุฏู ูููุน ุนุดูุงุฆู ุขูู (ููุทุฉ ูุณุงุฑ 0) ุฃู ูููุน ูุญุฏุฏ
    
    # ุงุฎุชูุงุฑ ูููุน ุนุดูุงุฆู (ูุฌุจ ุงูุชุฃูุฏ ุฃูู ูุณุงุฑ '0')
    while True:
        # ูุจุญุซ ุนู ุฎููุฉ ูุณุงุฑ 0 (Path)
        r = random.randint(1, ROWS - 2)
        c = random.randint(1, COLS - 2)
        if maze[r][c] == 0:
            break
            
    # ุฅูุดุงุก ุงูุนุฏู
    e = Enemy(c * CELL_SIZE, r * CELL_SIZE, maze, CELL_SIZE)
    e.choose_new_target()  # ุชุญุฏูุฏ ูุฏู ุฃููู ููุนุฏู
    enemies_group.add(e)
    enemy_list.append(e)

# ุฅุถุงูุฉ ูุฌููุนุฉ ุงูุฃุนุฏุงุก ุฅูู ูุฌููุนุฉ ูู ุงูู sprites (ููุฑุณู)


start_col, start_row = 1, 1
player = Player(start_col * CELL_SIZE, start_row * CELL_SIZE, maze)
all_sprites = pygame.sprite.Group()
all_sprites.add(player)
all_sprites.add(enemies_group)
all_sprites.add(coin_group)
# ูุชุบูุฑ ูุชุฎุฒูู ุญุงูุฉ ุงูุญุฑูุฉ
move_dir = {'up': False, 'down': False, 'left': False, 'right': False}


def draw_maze():
    for row in range(len(maze)):
        for col in range(len(maze[0])):
            rect = pygame.Rect(col*CELL_SIZE, row*CELL_SIZE, CELL_SIZE, CELL_SIZE)
            if maze[row][col] == 1:
                pygame.draw.rect(screen, BLACK, rect)
            elif maze[row][col] == 0:
                # โฌ๏ธ ุชู ุญุฐู ุฑุณู ุงูููู ุงูุฃุจูุถ ููุง ููุณูุงุญ ููุฎูููุฉ ุจุงูุธููุฑ
                pass
            elif maze[row][col] == 3:
                pygame.draw.rect(screen, GREEN, rect)


SCORE = 0
running = True
clock = pygame.time.Clock()
FPS = 60
while running:
    dt_ms = clock.tick(FPS)
    dt = dt_ms / 1000.0  # ุชุญููู ุฅูู ุซูุงูู
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False
        elif event.type == pygame.KEYDOWN:
            if event.key == pygame.K_UP:
                move_dir['up'] = True
            elif event.key == pygame.K_DOWN:
                move_dir['down'] = True
            elif event.key == pygame.K_LEFT:
                move_dir['left'] = True
            elif event.key == pygame.K_RIGHT:
                move_dir['right'] = True
        elif event.type == pygame.KEYUP:
            if event.key == pygame.K_UP:
                move_dir['up'] = False
            elif event.key == pygame.K_DOWN:
                move_dir['down'] = False
            elif event.key == pygame.K_LEFT:
                move_dir['left'] = False
            elif event.key == pygame.K_RIGHT:
                move_dir['right'] = False

    # ุชุญุฑูู ุงููุงุนุจ ุญุณุจ ุงูุถุบุท
    dx = 0
    dy = 0
    if move_dir['up']:
        dy = -1
    if move_dir['down']:
        dy = 1
    if move_dir['left']:
        dx = -1
    if move_dir['right']:
        dx = 1
    player.move(dx=dx, dy=dy, dt=dt)
    enemies_group.update(dt)
    coins_collected = pygame.sprite.spritecollide(player, coin_group, True) # True: ูุฅุฒุงูุฉ ุงููุงุฆู ุนูุฏ ุงูุงุตุทุฏุงู

    if coins_collected:
        # ุฒูุงุฏุฉ ุงูููุงุท ุจุนุฏุฏ ุงูุนููุงุช ุงููุฌูุนุฉ
        SCORE += len(coins_collected)
        print(f"๐ฐ ุฌูุนุช ุนููุฉ! ุงูููุงุท ุงูุญุงููุฉ: {SCORE}/{WINNING_SCORE}")
    screen.blit(background, (0, 0))
    draw_maze()
    all_sprites.draw(screen)
    display_score(screen, SCORE, WINNING_SCORE)
    pygame.display.flip()
    

# **ุงูุชุญูู ูู ุงูุงุตุทุฏุงู (Collision Detection)**
    # ูุชุญูู ููุง ุฅุฐุง ูุงู ุงููุงุนุจ ูุฏ ุงุตุทุฏู ุจุฃู ุนุฏู
    if pygame.sprite.spritecollideany(player, enemies_group):
        print("โ ุงูุชูุช ุงููุนุจุฉ! ููุฏ ุงุตุทุฏูุช ุจุงูุนุฏู.")
        running = False

    # โฌ๏ธ ุงูุชุญูู ูู ุงูููุฒ (ุชู ูููู ุฅูู ุฏุงุฎู ุงูุญููุฉ)
    if SCORE >= WINNING_SCORE:
        print(f"๐ ูุจุฑูู ูุง ุจุงุดูููุฏุณ! ูุตูุช ุฅูู ุงูููุงุท ุงููุทููุจุฉ ({SCORE}) ููุฒุช ุจุงููุนุจุฉ!")
        running = False
        
    # ุชุญูู ุงููุตูู ููููุฒ
    # ูุฐุง ุงูุชุญูู ูู ูุนุฏ ุถุฑูุฑูุงู ูููู ูุชุฑูู ูุชุญุฏูุฏ ูููุน ุงูุฎุณุงุฑุฉ/ุงูููุฒ
    row = player.rect.y // CELL_SIZE
    col = player.rect.x // CELL_SIZE
    
pygame.quit()